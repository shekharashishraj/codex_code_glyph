{% extends "base.html" %}

{% block content %}
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Interactive Text Editor</h2>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="highlight-toggle">
              <i class="bi bi-highlighter"></i> Highlight Mode
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-selections">
              Clear All
            </button>
          </div>
        </div>
        <div class="card-body">
          {% if preview %}
            <div class="mb-3">
              <div class="alert alert-info py-2">
                <small><strong>Instructions:</strong> Click on any word in the text below to create a mapping. Selected words will be highlighted and appear in the mapping panel.</small>
              </div>
            </div>
            <div id="interactive-text" class="interactive-text-container p-3 border rounded bg-white" style="min-height: 400px; max-height: 500px; overflow-y: auto; line-height: 1.6; font-family: 'Courier New', monospace;">
              {{ preview }}
            </div>
          {% else %}
            <div class="alert alert-warning">
              <h6>No text preview available</h6>
              <p class="mb-0">You can still attempt a remap using the manual entry form below if you know the words present in the PDF. For scanned pages, try <strong>OCR Mode</strong> in the mapping panel.</p>
            </div>
          {% endif %}
          
          {% if top_words %}
            <div class="mt-3">
              <h6 class="text-muted mb-2">Quick Selection - Most Frequent Words</h6>
              <div class="d-flex flex-wrap gap-1" data-role="word-suggestions">
                {% for word, count in top_words %}
                  <button type="button" class="btn btn-outline-secondary btn-sm quick-word-btn" data-word="{{ word }}" title="Click to select all instances of '{{ word }}' in text">
                    {{ word }} <span class="badge bg-secondary">{{ count }}</span>
                  </button>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <h2 class="h5 mb-0">Word Mappings</h2>
          <small class="text-muted">Define how selected words should be replaced</small>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('remap_pdf') }}" data-role="mapping-form">
            <input type="hidden" name="pdf_data" value="{{ pdf_data }}" />
            
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Processing Mode:</small>
              <div class="btn-group btn-group-sm flex-wrap" role="group" aria-label="Processing mode">
                <input type="radio" class="btn-check" name="processing_mode" id="mode-overlay" value="overlay" checked>
                <label class="btn btn-outline-primary" for="mode-overlay" title="Uses image overlays to preserve visual appearance">
                  <i class="bi bi-layers"></i> Overlay Mode
                </label>
                
                <input type="radio" class="btn-check" name="processing_mode" id="mode-font" value="font">
                <label class="btn btn-outline-primary" for="mode-font" title="Modifies font glyphs at the font level">
                  <i class="bi bi-fonts"></i> Font Mode
                </label>
                
                <input type="radio" class="btn-check" name="processing_mode" id="mode-ocr" value="ocr">
                <label class="btn btn-outline-primary" for="mode-ocr" title="Runs OCR to replace text inside rasterized or scanned PDFs">
                  <i class="bi bi-camera"></i> OCR Mode
                </label>
              </div>
              <small class="d-block text-muted mt-1">Overlay keeps the original look; use Font or OCR when you want the replacement to appear visually.</small>
            </div>
            
            <div id="selected-mappings" class="mb-3">
              <!-- Selected word mappings will appear here -->
            </div>
            
            <div class="border-top pt-3">
              <h6 class="text-muted mb-2">Manual Entry</h6>
              <div id="manual-mapping-rows">
                <div class="mapping-row mb-2">
                  <div class="input-group input-group-sm">
                    <input type="text" class="form-control original-word" name="original" placeholder="Original word" />
                    <span class="input-group-text">→</span>
                    <input type="text" class="form-control" name="replacement" placeholder="Replacement" />
                    <button type="button" class="btn btn-outline-danger" data-action="remove-manual-row" title="Remove">×</button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary w-100 mb-3" data-action="add-manual-row">
                + Add Manual Mapping
              </button>
            </div>
            
            <div class="d-grid">
              <button type="submit" class="btn btn-primary" disabled id="generate-btn">
                <i class="bi bi-download"></i> Generate Remapped PDF
              </button>
            </div>
            
            <div class="mt-2 text-center">
              <small class="text-muted" id="mapping-count">0 mappings defined</small>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <style>
    .interactive-text-container {
      cursor: text;
      user-select: text;
    }
    
    .word-selectable {
      cursor: pointer;
      padding: 1px 2px;
      border-radius: 2px;
      transition: all 0.2s ease;
    }
    
    .word-selectable:hover {
      background-color: #e3f2fd !important;
      transform: scale(1.05);
    }
    
    .word-selected {
      background-color: #ffeb3b !important;
      border: 1px solid #fbc02d;
      font-weight: 500;
    }
    
    .word-mapped {
      background-color: #c8e6c9 !important;
      border: 1px solid #4caf50;
      color: #2e7d32;
    }
    
    .mapping-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }
    
    .mapping-item:hover {
      border-color: #0d6efd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .mapping-item.highlight {
      border-color: #ffc107;
      background-color: #fff8e1;
    }
    
    .word-preview {
      font-family: 'Courier New', monospace;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.9em;
    }
    
    .quick-word-btn:hover {
      transform: translateY(-1px);
    }
    
    #highlight-toggle.active {
      background-color: #ffc107;
      border-color: #ffc107;
      color: #000;
    }
  </style>
{% endblock %}
